---
sidebar_position: 20
title: Oracle Buffer
---

import MarkdownImage from "/src/components/MarkdownImage";
import Link from "@docusaurus/Link";
import { Typography } from "@mui/material";

import OracleQueueBuffer from "/idl/accounts/OracleQueueBuffer.md";

An oracle queue buffer stores the list of active oracles for a queue. If an oracle fails to heartbeat before `oracleTimeout`, it may be removed from the buffer and no longer be assigned update request from the queue.

## Queue Configuration

### ‚öôÔ∏èmaxSize

When creating a queue with the OracleQueueInit instruction, an OracleQueueBuffer account must be initialized with a size of `8 Bytes + (32 Bytes √ó maxSize)`, where `maxSize` is the maximum number of oracles the queue can support. Once a buffer is full, oracles must be removed before new oracles can join the network.

## Functions

An oracle queue buffer account is responsible for the following functions:

- [**Store Active Oracles**](#store-active-oracles): Store a list of oracles to assign to update request.
- [**Garbage Collection**](#garbage-collection): Remove inactive oracles from the buffer.

### üöÄStore Active Oracles

The oracle queue buffer stores a list of oracle public keys that are ready to be assigned to update request.

### üöÄGarbage Collection

##### Stale Oracle

Oracle's are required to heartbeat at a regular interval to signal readiness. After a successful oracle heartbeat, the on-chain program will attempt to garbage collect inactive oracles using `gcIdx` to track its position iterating over the queue. If an oracle fails to heartbeat before `oracleTimeout`, it will no longer receive update requests from the queue. If an oracle fails to heartbeat `consecutiveOracleFailureLimit` times, it's queue permissions will be automatically revoked, requiring the oracle to be re-approved by the queue's `authority` before it can rejoin the network. This is to prevent stale oracles from wasting queue resources.

##### Stale Aggregators

If a data feed has misconfigured jobs or insufficient escrow it may fail to update, causing the aggregator to increment its number of failures on-chain. If an aggregator fails to update `consecutiveFeedFailureLimit` times, it's queue permissions will be automatically revoked, requiring the oracle to be re-approved by the queue's `authority` before it can rejoin the network. This is to prevent stale aggregators from wasting queue resources.

Aggregators must maintain a lease escrow to reward oracle operators for successfully updating a data feed. After an aggregators lease account is funded or has been re-funded, a queue may specify `feedProbationPeriod` to require N successful update requests or else it's queue permissions will be automatically revoked by the queue.

## Account Schema

### üì¶OracleQueueBuffer

<OracleQueueBuffer />
